name: Generate Readme (Scheduled)

on:
  schedule:
    - cron: "23 1 * * *"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  main:
    name: Generate Readme (Scheduled)
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Raycast Extensions
        run: |
          chmod +x ./clone_raycast_sparse.sh
          ./clone_raycast_sparse.sh --repo https://github.com/raycast/extensions.git

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.6.0

      - name: Generate Readme
        run: deno task run

      - name: Commit changes
        id: auto-commit-action
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Update Readme (On Schedule)
          commit_options: "--no-verify"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare data directory for Pages
        run: |
          # Create a directory structure that will be served by GitHub Pages
          mkdir -p _site/data
          cp data/data.json _site/data/
          cp data/history.json _site/data/

          # Copy and customize the index.html
          cp assets/index.html _site/index.html
          sed -i.bak "s|{{GITHUB_REPOSITORY}}|${{ github.repository }}|g" _site/index.html
          rm _site/index.html.bak

          # Copy types
          cp scripts/types/external.ts _site/types/types.d.ts

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: '_site'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
